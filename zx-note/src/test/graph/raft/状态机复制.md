### 状态机复制(State Machine Replication)
原文地址：https://netium.gitlab.io/2018/09/12/%E7%8A%B6%E6%80%81%E6%9C%BA%E5%A4%8D%E5%88%B6-(State-Machine-Replication)/

https://en.wikipedia.org/wiki/State_machine_replication  
 

在分布式环境中，如果要让一个服务具有容错能力，最直接的办法就是让一个服务的多个副本同时运行在不同的机器上。
每一个副本都称为一个节点。
但是，当一个服务的多个节点都在运行时，如何保证它们的状态都是同步的呢？或者说，如何让客户端无论将请求发送到
哪一个节点，都能得到相同的结果？实现这种同步的方法就是状态机复制。

状态机复制的理论基础是：如果集群里的每一个节点都运行着相同的确定性状态机S，
并且所有的状态机刚开始都处于相同的初始状态s<sub>0</sub>,那么给与这些状态机相同的输入序列I：
```
i1, i2, i3... in
```
这些状态机必定会经过相同的状态转换路径：
```
s0 --> s1 --> s2 --> s3 --> ... --> sn
```
最终到达相同的状态s<sub>n</sub>

在执行输入序列I的过程中，根据同步方式的不同就有了强一致性和最终一致性的区分：
- 如果对于序列I中的每一个i<sub>n</sub>，都需要所有的服务副本确认成功执行了i<sub>n</sub>之后，
才能执行i<sub>n+1</sub>，那么这个系统就是强一致性的系统。
- 如果取消掉这个限制，仅仅要求所有的服务副本执行相同的输入序列，但是完全各自独立执行，
而不需要在中间同步，那么就是最终一致性（每个服务最终都会到达相同的状态，但是到达的时间不确定）


### 输入日志(Input Log)
在没有故障的系统中，状态机处理之后可以将输入直接丢弃。但是在现实环境中，可能出现各种意外情况，
例如消息丢失、网络分区和处理速度过慢等。 

一种处理方式是将输入序列存储在日志中，当发生异常情况时，故障节点可以从另外一个节点请求日志，
以填补缺少的输入。

日志可能在内存中，也可能需要被持久化，根据系统的需求而定。 

### 检查点(Checkpoints)
如果不加控制，输入日志将会持续增长，直到耗尽所有的存储资源。为了可持续发展，必须去删除一些输入日志。
比如说，当所有节点都已经处理了某条输入，则不再需要这条输入的信息，这时就可以删除这条输入日志。

控制日志大小的常用技术是存储一个重复状态——检查点(checkpoint)，然后丢弃检查点之前的所有日志。

**检查点是当前状态的一个副本**，一般会比较大。 但检查点通常比输入日志的总大小要小得多，因此可以节省空间。 

可以在状态机中增加一个额外的操作：CHECKPOINT。每个节点除了维护当前的状态值以外，
还维护一个检查点。当日志变大时，由一个节点（通常是主节点？）发出一个CHECKPOINT命令（就像一个普通的客户端请求一样），
系统将确保所有无故障的节点以相同的顺序处理这条命令，处理完毕之后就可以丢弃这个检查点之前的所有日志。

如果由于一些异常情况，某个副本需要从其他副本获取输入日志，但是这条日志在检查点之前，
已经被删除了，这时这个副本必须重新加入系统(re-join)


### 重新配置(Reconfiguration)
重新配置 允许在处理客户端请求的同时，有节点加入和退出集群。例如有计划的集群维护，或者节点故障。

reconfiguration包括 Quitting(退出) 和 Joining(加入)

### 退出(Quitting)
如果一个节点检测到它的状态或者输出是错误的，它可能会选择退出集群。
系统管理员也可能手动的移除一个节点来进行维护。 

退出的动作向状态机产生一个新的输入称为QUIT。

### 加入(Joining)
在退出之后，一个出现故障的节点可能会选择重启或者重新加入集群。也有可能是系统管理员手动
新增了一个节点。

新节点加入时，必须将自身的状态更新到与集群的状态一致。 

### 状态转移(State Transfer)
当一个新的节点加入，或者一个旧的节点重启时，必须将它复制到系统当前的状态才能开始处理新的输入。

理论上，这需要将 **自系统运行以来所有的输入** 按顺序应用到新的节点上。

通常的做法是先从其他节点复制一份检查点，然后再从检查点进行状态转移。
检查点可能很大，需要很长的传输时间。在此期间，可能会有新的输入。
新节点还必须接收新输入并在接收完检查点后应用它们。

优化方法： 
1. 只传输新节点与其他节点状态的差异部分，而不是传输整个检查点，
这需要了解状态机的内部实现。 
2. 通过压缩来加快传输速度。 























